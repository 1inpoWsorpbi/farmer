---
title: "Managed Identity"
date: 2020-10-11T19:10:03.8036860-04:00
chapter: false
weight: 1
---

#### Overview
Managed Identity is used to create an identity that resources can run under automatically. This is similar to a service
principal except that there is no credential to manage and the authorization token is retrieved through a secure
internal handshake between the resource and the identity service in Azure. This brings two primary benefits:

* There is no client secret or certificate to configure and rotate because this is handled implicitly by Azure infrastructure.
* The identity is tied to one or more specific resources, so cannot be used by anything else, like a user.

Once created, the managed identity resource can be referenced in ARM templates to get the `principalId` and create
role assignments to assign access to resources or to grant access in key vault access policies.

While system assigned identities are generated by Azure when the resource is created, a user assigned identity can be
created separately from provisioning of the resource or resources that will use it. This means the identities and 
privileges can be created granted separately from the infrastructure deployment itself. The `userAsasignedIdentity`
builder can be used for this.

* User Assigned Identity (`Microsoft.ManagedIdentity/userAssignedIdentities`)

#### User Assigned Identity Keywords
The `userAssignedIdentity` builder constructs user assigned managed identities which can be created and then assigned
to one or more resources.

| Keyword | Purpose |
|-|-|
| name | Sets the name of the user assigned identity. |
| add_tag | Adds a tag to the user assigned identity resource. |
| add_tags | Adds multiple tags to the user assigned identity resource. |

#### Example

In this example, a container group needs a secret from a key vault. By assigning an identity to the container group, the
application code can be granted access to the key vault with no need to provide it a client secret.

```fsharp
open Farmer
open Farmer.Builders

let containerGroupMsi =
    userAssignedIdentity {
        name "container-group-msi"
    }

let group =
    containerGroup {
        name "myapp-with-msi"
        add_instances [
            containerInstance {
                name "my-app"
                image "myregistry.azurecr.io/myapp:latest"
            }
        ]
        // All of the containers in this group share this managed identity.
        user_assigned_identity containerGroupMsi.Name
    }

let msiResourceId = (ResourceId.create(userAssignedIdentities, containerGroupMsi.Name)).Eval()
let msiPrincipal = PrincipalId (ArmExpression.create (sprintf "reference(%s).principalId" msiResourceId))

let vault =
    keyVault {
        name "my-vault"
        sku Sku.Standard

        add_access_policies [
            // Grant this managed identity access to read the key vault secrets.
            accessPolicy { object_id msiPrincipal; secret_permissions [ Secret.Get ] }
        ]
    }

let template = arm {
    location Location.EastUS
    add_resource msi
    add_resource group
    add_resource vault
}
```
